import json
import requests
import time
import os

question_ids = [180,187,195,223,237,269,427,456,476,479,498,509,526,784,808,1022,1108,1297,1311,1329,1332,1336,1338,1339,1340,1341,1345,1347,1348,1349,1373,1389,1400,1402,1408,1427,1441,1446,1455,1468,1469,1476,1477,1483,1504,1508,1511,1517,1521,1525,1526,1527,1536,1537,1539,1545,1566,1572,1575,1579,1584,1585,1589,1598,1604,1607,1615,1629,1650,1706,1714,1742,1768,1770,1776,1785,1792,1793,1798,1800,1803,1863,1866,1867,1868,1870,1915,1920,1921,1922,1923,1925,1928,1929,1931,1933,1936,1937,1942,1943,1957,1991,1993,1996,1997,1998,2000,2002,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2017,2018,2019,2020,2021,2022,2023,2024,2025,2031,2033,2034,2035,2037,2039,2040,2042,2043,2048,2049,2051,2052,2054,2057,2058,2059,2060,2061,2079,2081,2083,2084,2088,2091,2098,2099,2102,2108,2113,2122,2125,2128,2131,2132,2137,2142,2145,2146,2158,2159,2167,2169,2171,2179,2183,2186,2189,2190,2192,2194,2195,2197,2199,2200,2209,2211,2214,2215,2216,2217,2218,2227,2228,2231,2233,2234,2235,2241,2249,2251,2252,2253,2255,2265,2268,2269,2270,2271,2272,2273,2274,2275,2276,2277,2278,2279,2280,2281,2282,2283,2284,2286,2288,2289,2290,2294,2297,2305,2306,2310,2311,2312,2314,2315,2316,2321,2322,2328,2331,2333,2334,2337,2339,2340,2341,2342,2344,2345,2348,2349,2350,2351,2352,2355,2360,2361,2362,2365,2366,2367,2368,2369,2371,2372,2374,2376,2382,2389,2390,2394,2395,2398,2399,2411,2413,2414,2415,2420,2421,2424,2425,2428,2429,2432,2435,2438,2439,2440,2441,2442,2444,2447,2448,2452,2454,2457,2487,2488,2490,2498,2499,2502,2504,2505,2515,2518,2519,2522,2523,2524,2525,2526,2527,2528,2529,2532,2534,2535,2537,2538,2539,2540,2542,2544,2556,2557,2559,2563,2566,2570,2574,2581,2582,2584,2585,2586,2587,2588,2589,2590,2591,2596,2597,2598,2599,2600,2601,2602,2603,2604,2605,2606,2607,2608,2609,2610,2611,2612,2613,2618,2632,2638,2639,2643,2644,2649,2650,2652,2653,2656,2657,2658,2659,2662,2663,2664,2667,2668,2669,2671,2672,2673,2676,2683,2760,2796,2800,2802,2803,2805,2806,2807,2808,2811,2812,2813,2815,2817,2818,2819,2820,2823,2825,2826,2827,2828,2829,2830,2831,2832,2834,2835,2836,2838,2839,2840,2843,2844,2846,2847,2848,2849,2850,2851,2852,2853,2857,2859,2860,2861,2862,2863,2864,2867,2868,2870,2871,2872,2874,2875,2876,2877,2878,2879,2880,2884,2885,2888,2892,2898,2901,2903,2904,2906,2907,2908,2909,2910,2911,2912,2913,2915,2916,2917,2918,2919,2920,2921,2923,2926,2927,2928,2930,2931,2932,2935,2937,2938,2939,2940,2942,2943,2945,2946,2947,2948,2949,2950,2952,2953,2954,2955,2961,2962,2963,2964,2968,2969,2973,2976,2977,2979,2982,2983,2984,2986,2987,2988,2989,2991,2992,2994,2995,2998,2999,3000,3001,3009,3010,3011,3017,3020,3021,3022,3030,3032,3033,3044,3045,3046,3047,3048,3049,3051,3052,3053,3054,3055,3056,3057,3059,3065,3074,3076,3079,3080,3081,3082,3083,3084,3086,3087,3088,3089,3090,3091,3092,3093,3094,3095,3096,3097,3099,3100,3101,3102,3103,3104,3106,3107,3108,3109,3111,3112,3113,3114,3116,3120,3126,3127,3128,3129,3130,3133,3134,3135,3136,3138,3144,3146,3147,3148,3149,3150,3151,3152,3154,3155,3164,3166,3167,3168,3169,3171,3172,3173,3175,3176,3180,3181,3182,3183,3184,3185,3186,3188,3191,3192,3193,3196,3197,3198,3199,3200,3201,3202,3203,3204,3206,3208,3209,3210,3211,3213,3214,3216,3218,3220,3222,3224,3226,3227,3232,3236,3237,3240,3241,3244,3245,3246,3247,3255,3256,3257,3267,3373,3449,3451,3452,3454,3455,3456,3457,3461,3465,3467,3469,3473,3474,3479,3583,3634,3942,4021,4022,4023,4024,4027,4068,4072,4076,4115,4118,4120,4121,4122,4127,4130,4131,4293,4294,4299,4300,4302,4303,4304,4305,4306,4307,4308,4309,4310,4311,4312,4313,4314,4315,4316,4317,4318,4319,4320,4321,4322,4323,4324,4325,4326,4327,4328,4329,4330,4331,4332,4333,4335,4336,4337,4338,4339,4340,4341,4342,4343,4344,4345,4346,4347,4348,4349,4350,4351,4352,4353,4354,4403,4406,4407,4421,4422,4423,4429,4430,4431,4436,4446,4447,4461,4462,4463,4498,4505,4506,4507,4508,4509,4510,4511,4512,4515,4516,4518,4519,4522,4529,4532,4533,4534,4535,4536,4537,4539,4540,4541,4542,4544,4545,4552,4554,4556,4557,4559,4561,4562,4565,5288,5290,5293,5295,5370,5371,5372,5374,5375,5376,5377,5378,5379,5380,5381,5382,5383,5384,5385,5386,5387,5388,5389,5390,5391,5392,5393,5394,5395,5396,5397,5398,5399,5400,5401,5402,5403,5404,5405,5406,5407,5408,5409,5410,5411,5412,5413,5414,5415,5416,5417,5418,5419,5420,5421,5422,5423,5424,5425,5426,5427,5428,5430,5431,5432,5433,5434,5435,5436,5437,5438,5439,5440,5442,5443,5444,5445,5447,5448,5449,5450,5451,5452,5453,5454,5455,5456,5457,5458,5460,5461,5462,5463,5464,5465,5466,5467,5468,5469,5470,5472,5473,5474,5475,5476,5477,5478,5482,5483,5484,5485,5486,5487,5488,5489,5490,5491,5492,5494,5495,5496,5499,5500,5501,5502,5503,5504,5505,5506,5507,5508,5509,5510,5511,5512,5513,5515,5516,5517,5518,5519,5520,5521,5522,5523,5524,5525,5526,5527,5528,5530,5531,5532,5534,5535,5536,5537,5538,5540,5542,5543,5544,5546,5548,5549,5551,5552,5553,5554,5555,5556,5558,5560,5561,5562,5564,5565,5566,5567,5568,5569,5570,5571,5572,5573,5574,5575,5576,5577,5578,5579,5580,5581,5582,5583,5584,5585,5586,5587,5588,5589,5590,5591,5592,5593,5594,5595,5596,5597,5598,5599,5600,5601,5602,5603,5604,5605,5606,5607,5608,5609,5610,5611,5612,5613,5614,5615,5616,5617,5618,5619,5620,5621,5622,5623,5624,5625,5626,5627,5628,5629,5630,5631,5632,5633,5634,5635,5636,5637,5638,5639,5640,5641,5642,5643,5644,5645,5646,5647,5648,5649,5650,5651,5652,5653,5654,5655,5656,5657,5658,5659,5660,5661,5662,5663,5664,5665,5666,5667,5669,5670,5671,5672,5673,5674,5675,5676,5677,5678,5679,5681,5682,5683,5684,5685,5689,5691,5692,5693,5696,5697,103475,104467,104468,104472,104474,104475,104476,104477,104478,104479,104480,104481,104482,104484,104485,104486,104487,104488,104489,104490,104491,104492,104493,104494,104495,104530,104550,104551,104553,104567]

url_template = "https://etesty2.mdcr.cz/api/v1/PublicWeb/Question/{}"
base_url = "https://etesty2.mdcr.cz"

# slo≈æky pro m√©dia
os.makedirs("images", exist_ok=True)
os.makedirs("videos", exist_ok=True)

def download_media(media, base_url, question_id, answer_index=None):
    """St√°hne media content a vr√°t√≠ lok√°ln√≠ cestu"""
    if not media:
        return None
    
    media_url = base_url + media["mediaUrl"]
    
    # vezmu n√°zev souboru z mediaUrl (z cesty)
    import os.path
    media_name = os.path.basename(media["mediaUrl"])
    
    # urƒç√≠m slo≈æku podle typu
    if media["mediaFormatCode"].startswith("image"):
        folder = "images"
    elif media["mediaFormatCode"].startswith("video"):
        folder = "videos"
    else:
        folder = "other"
    
    os.makedirs(folder, exist_ok=True)
    
    # # p≈ôid√°m prefix pro lep≈°√≠ organizaci
    # if answer_index is not None:
    #     prefix = f"Q{question_id}_A{answer_index}_"
    # else:
    #     prefix = f"Q{question_id}_"
    
    file_path = os.path.join(folder, media_name)
    
    # st√°hnu soubor jen pokud u≈æ nen√≠ ulo≈æen√Ω
    if not os.path.exists(file_path):
        r = requests.get(media_url)
        if r.status_code == 200:
            with open(file_path, "wb") as f:
                f.write(r.content)
            print(f"üì• Sta≈æen {media_name} ‚Üí {folder}/")
        else:
            print(f"‚ö†Ô∏è Nepoda≈ôilo se st√°hnout {media_url}")
            return None
    
    return file_path

all_questions = []

for qid in question_ids:
    url = url_template.format(qid)
    resp = requests.get(url)
    if resp.status_code != 200:
        print(f"‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ {qid} (HTTP {resp.status_code})")
        continue

    data = resp.json()

    # St√°hnu media content z hlavn√≠ ot√°zky
    question_media = data.get("mediaContent")
    if question_media:
        local_path = download_media(question_media, base_url, qid)
        if local_path:
            data["localMediaPath"] = local_path

    # St√°hnu media content ze v≈°ech odpovƒõd√≠
    answers = data.get("questionAnswers", [])
    if answers:
        for i, answer in enumerate(answers):
            answer_media = answer.get("mediaContent")
            if answer_media:
                local_path = download_media(answer_media, base_url, qid, i)
                if local_path:
                    answer["localMediaPath"] = local_path

    all_questions.append(data)
    print(f"‚úÖ Naƒçtena ot√°zka {qid}")
    time.sleep(0.1)

with open("otazky.json", "w", encoding="utf-8") as f:
    json.dump(all_questions, f, ensure_ascii=False, indent=2)

print("üéâ Hotovo! V≈°echny ot√°zky, odpovƒõdi a m√©dia jsou ulo≈æen√©.")

